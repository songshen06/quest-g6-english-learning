<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA å®‰è£…è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        button:hover {
            background: #4f46e5;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .icon-preview {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            align-items: center;
        }
        .icon-item {
            text-align: center;
        }
        .icon-item img {
            width: 64px;
            height: 64px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ PWA å®‰è£…è°ƒè¯•å·¥å…·</h1>
        <p>æ­¤å·¥å…·å¸®åŠ©è¯Šæ–­ PWA å®‰è£…é—®é¢˜ï¼Œæ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§å’Œå®‰è£…æ¡ä»¶ã€‚</p>

        <div id="browser-info" class="status info">
            æ­£åœ¨æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§...
        </div>

        <div id="pwa-status" class="status info">
            æ­£åœ¨æ£€æŸ¥ PWA çŠ¶æ€...
        </div>

        <div id="install-status" class="status info">
            æ­£åœ¨æ£€æŸ¥å®‰è£…æ¡ä»¶...
        </div>

        <div class="icon-preview">
            <div class="icon-item">
                <img src="pwa-icon.svg" alt="PWA Icon SVG">
                <div>SVG å›¾æ ‡</div>
            </div>
            <div class="icon-item">
                <img src="pwa-192x192.png" alt="PWA Icon 192">
                <div>192x192 PNG</div>
            </div>
            <div class="icon-item">
                <img src="pwa-512x512.png" alt="PWA Icon 512">
                <div>512x512 PNG</div>
            </div>
        </div>

        <h3>ğŸ“‹ ç³»ç»Ÿä¿¡æ¯</h3>
        <div id="system-details" class="details">
            æ­£åœ¨æ”¶é›†ç³»ç»Ÿä¿¡æ¯...
        </div>

        <h3>ğŸ” PWA æ£€æŸ¥ç»“æœ</h3>
        <div id="pwa-details" class="details">
            æ­£åœ¨æ£€æŸ¥ PWA åŠŸèƒ½...
        </div>

        <div style="margin-top: 30px;">
            <button id="check-btn" onclick="runChecks()">ğŸ” é‡æ–°æ£€æŸ¥</button>
            <button id="install-btn" onclick="tryInstall()" disabled>ğŸ“± å°è¯•å®‰è£…</button>
            <button id="debug-btn" onclick="enableDebug()">ğŸ› å¯ç”¨è°ƒè¯•</button>
        </div>

        <h3>ğŸ“ å®‰è£…æŒ‡å—</h3>
        <div class="info">
            <h4>æ¡Œé¢æµè§ˆå™¨ (Chrome/Edge):</h4>
            <ul>
                <li>ç¡®ä¿ä½¿ç”¨ HTTPS æˆ– localhost</li>
                <li>æŸ¥æ‰¾åœ°å€æ çš„å®‰è£…å›¾æ ‡ (âŠ•)</li>
                <li>æˆ–è€…ç­‰å¾…è‡ªåŠ¨å®‰è£…æç¤º</li>
            </ul>

            <h4>ç§»åŠ¨è®¾å¤‡:</h4>
            <ul>
                <li><strong>Android Chrome:</strong> èœå•ä¸­æŸ¥æ‰¾"æ·»åŠ åˆ°ä¸»å±å¹•"</li>
                <li><strong>iOS Safari:</strong> åˆ†äº«æŒ‰é’® â†’ "æ·»åŠ åˆ°ä¸»å±å¹•"</li>
            </ul>
        </div>
    </div>

    <script>
        let deferredPrompt = null;
        let debugMode = false;

        function log(message, type = 'info') {
            if (debugMode) {
                console.log(`[PWA Debug] ${message}`);
            }
        }

        function updateStatus(id, message, type = 'info') {
            const element = document.getElementById(id);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        function updateDetails(id, content) {
            document.getElementById(id).textContent = content;
        }

        function runChecks() {
            log('å¼€å§‹è¿è¡Œ PWA æ£€æŸ¥...');

            // 1. æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
            checkBrowserCompatibility();

            // 2. æ£€æŸ¥ PWA çŠ¶æ€
            checkPWAStatus();

            // 3. æ£€æŸ¥å®‰è£…æ¡ä»¶
            checkInstallConditions();

            // 4. æ”¶é›†ç³»ç»Ÿä¿¡æ¯
            collectSystemInfo();
        }

        function checkBrowserCompatibility() {
            log('æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§...');

            const userAgent = navigator.userAgent;
            const isChrome = /Chrome/.test(userAgent) && /Google Inc/.test(navigator.vendor);
            const isFirefox = /Firefox/.test(userAgent);
            const isSafari = /Safari/.test(userAgent) && /Apple Computer/.test(navigator.vendor);
            const isEdge = /Edg/.test(userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(userAgent);
            const isAndroid = /Android/.test(userAgent);

            let compatibility = "âœ… æ”¯æŒè‰¯å¥½";
            let details = `æµè§ˆå™¨: ${userAgent}\n`;

            if (isIOS) {
                compatibility = "âš ï¸ iOS è®¾å¤‡ - éœ€è¦æ‰‹åŠ¨å®‰è£…";
                details += "iOS: æ˜¯\n";
                details += "PWA æ”¯æŒ: æœ‰é™\n";
                details += "å®‰è£…æ–¹å¼: Safari åˆ†äº«èœå• â†’ æ·»åŠ åˆ°ä¸»å±å¹•\n";
            } else if (isChrome || isEdge) {
                details += "PWA æ”¯æŒ: å®Œæ•´\n";
                details += "è‡ªåŠ¨å®‰è£…: æ”¯æŒ\n";
            } else if (isFirefox) {
                details += "PWA æ”¯æŒ: éƒ¨åˆ†æ”¯æŒ\n";
                compatibility = "âš ï¸ Firefox - æœ‰é™æ”¯æŒ";
            } else {
                compatibility = "âŒ æµè§ˆå™¨ä¸æ”¯æŒ";
                details += "PWA æ”¯æŒ: ä¸æ”¯æŒ\n";
            }

            details += `å¹³å°: ${isIOS ? 'iOS' : isAndroid ? 'Android' : 'Desktop'}\n`;
            details += `HTTPS: ${location.protocol === 'https:' ? 'æ˜¯' : 'å¦'}\n`;

            updateStatus('browser-info', compatibility, isIOS || (!isChrome && !isEdge) ? 'warning' : 'success');
            updateDetails('system-details', details);
        }

        function checkPWAStatus() {
            log('æ£€æŸ¥ PWA çŠ¶æ€...');

            let status = "ğŸ” PWA æ£€æŸ¥ä¸­...";
            let details = "";
            let statusType = 'info';

            // æ£€æŸ¥ Service Worker
            if ('serviceWorker' in navigator) {
                details += "âœ… Service Worker API: æ”¯æŒ\n";

                navigator.serviceWorker.getRegistrations().then(registrations => {
                    if (registrations.length > 0) {
                        details += `âœ… Service Worker å·²æ³¨å†Œ: ${registrations.length} ä¸ª\n`;
                        registrations.forEach((reg, index) => {
                            details += `  - ${reg.scope} (${reg.active ? 'æ´»è·ƒ' : 'æœªæ¿€æ´»'})\n`;
                        });
                    } else {
                        details += "âš ï¸ Service Worker: æœªæ³¨å†Œ\n";
                        statusType = 'warning';
                    }
                    updateDetails('pwa-details', details);
                });
            } else {
                details += "âŒ Service Worker API: ä¸æ”¯æŒ\n";
                statusType = 'error';
            }

            // æ£€æŸ¥ Web App Manifest
            if ('onbeforeinstallprompt' in window) {
                details += "âœ… beforeinstallprompt äº‹ä»¶: æ”¯æŒ\n";
            } else {
                details += "âš ï¸ beforeinstallprompt äº‹ä»¶: ä¸æ”¯æŒ (å¯èƒ½å½±å“è‡ªåŠ¨å®‰è£…)\n";
                statusType = 'warning';
            }

            // æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            const isWebAppiOS = (window.navigator as any).standalone === true;

            if (isStandalone || isWebAppiOS) {
                status = "âœ… PWA å·²å®‰è£…";
                statusType = 'success';
                details += "âœ… åº”ç”¨æ¨¡å¼: æ˜¯\n";
            } else {
                status = "ğŸ“± PWA æœªå®‰è£… - å¯ä»¥å®‰è£…";
                details += "ğŸ“± åº”ç”¨æ¨¡å¼: å¦ (å¯ä»¥å®‰è£…)\n";
            }

            updateStatus('pwa-status', status, statusType);
        }

        function checkInstallConditions() {
            log('æ£€æŸ¥å®‰è£…æ¡ä»¶...');

            let status = "ğŸ” æ£€æŸ¥å®‰è£…æ¡ä»¶...";
            let details = "";
            let canInstall = false;

            // æ£€æŸ¥ HTTPS
            if (location.protocol === 'https:' || location.hostname === 'localhost') {
                details += "âœ… å®‰å…¨è¿æ¥: æ˜¯\n";
                canInstall = true;
            } else {
                details += "âŒ å®‰å…¨è¿æ¥: å¦ (éœ€è¦ HTTPS)\n";
                status = "âŒ ä¸æ»¡è¶³å®‰è£…æ¡ä»¶";
                updateStatus('install-status', status, 'error');
                return;
            }

            // æ£€æŸ¥ Manifest
            fetch('manifest.webmanifest')
                .then(response => {
                    if (response.ok) {
                        details += "âœ… Manifest æ–‡ä»¶: å¯è®¿é—®\n";
                        return response.json();
                    } else {
                        throw new Error('Manifest ä¸å¯è®¿é—®');
                    }
                })
                .then(manifest => {
                    details += `âœ… åº”ç”¨åç§°: ${manifest.name}\n`;
                    details += `âœ… å›¾æ ‡æ•°é‡: ${manifest.icons ? manifest.icons.length : 0}\n`;

                    // æ£€æŸ¥å›¾æ ‡æ–‡ä»¶
                    if (manifest.icons && manifest.icons.length > 0) {
                        const iconCheck = manifest.icons[0];
                        fetch(iconCheck.src)
                            .then(iconResponse => {
                                if (iconResponse.ok) {
                                    details += `âœ… å›¾æ ‡æ–‡ä»¶: å¯è®¿é—®\n`;
                                    status = "âœ… æ»¡è¶³å®‰è£…æ¡ä»¶";
                                    document.getElementById('install-btn').disabled = false;
                                } else {
                                    details += `âš ï¸ å›¾æ ‡æ–‡ä»¶: ä¸å¯è®¿é—®\n`;
                                    status = "âš ï¸ éƒ¨åˆ†æ¡ä»¶æ»¡è¶³";
                                }
                                updateStatus('install-status', status, canInstall ? 'success' : 'warning');
                                updateDetails('pwa-details', details);
                            });
                    }
                })
                .catch(error => {
                    details += `âŒ Manifest é”™è¯¯: ${error.message}\n`;
                    status = "âŒ ä¸æ»¡è¶³å®‰è£…æ¡ä»¶";
                    updateStatus('install-status', status, 'error');
                    updateDetails('pwa-details', details);
                });
        }

        function collectSystemInfo() {
            log('æ”¶é›†ç³»ç»Ÿä¿¡æ¯...');

            const info = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                protocol: location.protocol,
                hostname: location.hostname,
                port: location.port,
                pathname: location.pathname,
                screen: `${screen.width}x${screen.height}`,
                devicePixelRatio: window.devicePixelRatio,
                timestamp: new Date().toISOString()
            };

            const details = Object.entries(info)
                .map(([key, value]) => `${key}: ${value}`)
                .join('\n');

            updateDetails('system-details', details);
        }

        function tryInstall() {
            log('å°è¯•è§¦å‘å®‰è£…...');

            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        log('ç”¨æˆ·æ¥å—äº†å®‰è£…');
                        updateStatus('install-status', 'âœ… å®‰è£…å·²æ¥å—ï¼', 'success');
                    } else {
                        log('ç”¨æˆ·æ‹’ç»äº†å®‰è£…');
                        updateStatus('install-status', 'âŒ ç”¨æˆ·æ‹’ç»äº†å®‰è£…', 'warning');
                    }
                    deferredPrompt = null;
                });
            } else {
                updateStatus('install-status', 'âŒ æ— å¯ç”¨å®‰è£…æç¤º', 'warning');
                log('æ—  deferredPrompt å¯ç”¨');
            }
        }

        function enableDebug() {
            debugMode = !debugMode;
            const btn = document.getElementById('debug-btn');
            btn.textContent = debugMode ? 'ğŸ”‡ å…³é—­è°ƒè¯•' : 'ğŸ› å¯ç”¨è°ƒè¯•';

            if (debugMode) {
                console.log('ğŸ› PWA è°ƒè¯•æ¨¡å¼å·²å¯ç”¨');
                console.log('ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰‹åŠ¨æ£€æŸ¥:');
                console.log('- navigator.serviceWorker.getRegistrations()');
                console.log('- window.matchMedia("(display-mode: standalone)").matches');
                console.log('- æ£€æŸ¥ beforeinstallprompt äº‹ä»¶');
            }
        }

        // ç›‘å¬ beforeinstallprompt äº‹ä»¶
        window.addEventListener('beforeinstallprompt', (e) => {
            log('beforeinstallprompt äº‹ä»¶è§¦å‘ï¼');
            e.preventDefault();
            deferredPrompt = e;

            updateStatus('install-status', 'ğŸ¯ PWA å¯ä»¥å®‰è£…ï¼', 'success');
            document.getElementById('install-btn').disabled = false;

            if (debugMode) {
                console.log('ğŸ¯ beforeinstallprompt äº‹ä»¶è¯¦æƒ…:', e);
            }
        });

        // ç›‘å¬å®‰è£…æˆåŠŸäº‹ä»¶
        window.addEventListener('appinstalled', () => {
            log('appinstalled äº‹ä»¶è§¦å‘ï¼');
            updateStatus('pwa-status', 'ğŸ‰ PWA å®‰è£…æˆåŠŸï¼', 'success');
            updateStatus('install-status', 'âœ… å·²å®‰è£…', 'success');
            document.getElementById('install-btn').disabled = true;
        });

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæ£€æŸ¥
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æ£€æŸ¥...');
            setTimeout(runChecks, 1000);
        });

        // ç«‹å³è¿è¡ŒåŸºç¡€æ£€æŸ¥
        runChecks();
    </script>
</body>
</html>